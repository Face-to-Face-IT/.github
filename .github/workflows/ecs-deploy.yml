name: ECS Deploy

on:
  workflow_call:
    inputs:
      environment:
        description: Target environment (development, production)
        type: string
        required: true
      image:
        description: "Full Docker image URI to deploy (e.g. ghcr.io/org/repo:tag)"
        type: string
        required: true
      version:
        description: Version string for logging/summary
        type: string
        default: ""
      aws-region:
        description: AWS region
        type: string
        default: "us-east-2"
      wait-for-stable:
        description: Wait for ECS service to stabilize after deployment
        type: boolean
        default: true
    secrets:
      aws-role-arn:
        description: IAM role ARN to assume for deployment
        required: true

# Expects these environment-scoped variables on the caller repo:
#   vars.ECS_CLUSTER      - ECS cluster name
#   vars.ECS_SERVICE       - ECS service name
#   vars.ECS_TASK_FAMILY   - ECS task definition family name

jobs:
  deploy:
    name: Deploy to ${{ inputs.environment }}
    runs-on: blacksmith-4vcpu-ubuntu-2404
    environment: ${{ inputs.environment }}
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Validate environment variables
        run: |
          missing=()
          [ -z "${{ vars.ECS_CLUSTER }}" ] && missing+=("ECS_CLUSTER")
          [ -z "${{ vars.ECS_SERVICE }}" ] && missing+=("ECS_SERVICE")
          [ -z "${{ vars.ECS_TASK_FAMILY }}" ] && missing+=("ECS_TASK_FAMILY")
          if [ ${#missing[@]} -gt 0 ]; then
            echo "::error::Missing environment variables for '${{ inputs.environment }}': ${missing[*]}"
            echo "Set these as environment-scoped variables in the repo's GitHub Environment settings."
            exit 1
          fi

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.aws-role-arn }}
          aws-region: ${{ inputs.aws-region }}

      - name: Update ECS task definition
        id: task-def
        run: |
          IMAGE="${{ inputs.image }}"
          TASK_FAMILY="${{ vars.ECS_TASK_FAMILY }}"

          echo "Deploying image: $IMAGE"
          echo "Task family: $TASK_FAMILY"

          TASK_DEF=$(aws ecs describe-task-definition \
            --task-definition "$TASK_FAMILY" \
            --query 'taskDefinition' \
            --output json)

          NEW_TASK_DEF=$(echo "$TASK_DEF" | IMAGE="$IMAGE" python3 -c "
          import json, os, sys
          td = json.load(sys.stdin)
          td['containerDefinitions'][0]['image'] = os.environ['IMAGE']
          for key in ['taskDefinitionArn', 'revision', 'status', 'requiresAttributes',
                      'compatibilities', 'registeredAt', 'registeredBy']:
              td.pop(key, None)
          json.dump(td, sys.stdout)
          ")

          NEW_ARN=$(aws ecs register-task-definition \
            --cli-input-json "$NEW_TASK_DEF" \
            --query 'taskDefinition.taskDefinitionArn' \
            --output text)
          echo "Registered task definition: $NEW_ARN"
          echo "task-definition-arn=$NEW_ARN" >> $GITHUB_OUTPUT

      - name: Update ECS service
        run: |
          aws ecs update-service \
            --cluster ${{ vars.ECS_CLUSTER }} \
            --service ${{ vars.ECS_SERVICE }} \
            --task-definition "${{ steps.task-def.outputs.task-definition-arn }}" \
            --force-new-deployment

      - name: Wait for deployment to stabilize
        if: inputs.wait-for-stable
        run: |
          echo "Waiting for deployment to stabilize..."
          aws ecs wait services-stable \
            --cluster ${{ vars.ECS_CLUSTER }} \
            --services ${{ vars.ECS_SERVICE }}

      - name: Deployment summary
        run: |
          echo "## Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | ${{ inputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Image** | \`${{ inputs.image }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Version** | ${{ inputs.version || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Cluster** | ${{ vars.ECS_CLUSTER }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Service** | ${{ vars.ECS_SERVICE }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Task Definition** | \`${{ steps.task-def.outputs.task-definition-arn }}\` |" >> $GITHUB_STEP_SUMMARY
